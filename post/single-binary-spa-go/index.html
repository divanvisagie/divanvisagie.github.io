<!DOCTYPE html>
<html lang="en">
  <head>
    <title>A single binary SPA using Go - Divan Visagie</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0"
    />
    <meta name="description" content="A single binary SPA using Go - Using statik and echo with to serve up a single binary React app" />
    <meta property="og:description" content="A single binary SPA using Go - Using statik and echo with to serve up a single binary React app" />
    <meta property="og:title" content="A single binary SPA using Go" />
    <meta name="twitter:title" content="A single binary SPA using Go" />
    <meta name="author" content="Divan Visagie" />
    <link href="/favicon.ico" rel="icon" type="image/x-icon" />
    <meta property="og:image" content="https://divanv.com/post/single-binary-spa-go/go-spa-head.png" />
    <meta name="twitter:image" content="https://divanv.com/post/single-binary-spa-go/go-spa-head.png" />
    <meta name="twitter:card" content="summary" />
    <meta property="og:url" content="/" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Divan Visagie" />

    <meta name="generator" content="Custom" />
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/highlight.min.css" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/katex.min.css" />
  </head>

  <body>
    <nav>
      <div>
        <h1>
          <a href="/">Divan <span class="full">Visagie</span></a><a class="home-tilde" href="/">/~</a>
        </h1>

        <div class="links">
          <h2>
            <a href="/post">Posts</a>
          </h2>
          <h2>
            <a href="/about">About</a>
          </h2>
        </div>
      </div>
    </nav>

    <div class="content"><div class="post-content"><h1 class="title">A single binary SPA using Go</h1>
<h2 class="subtitle">Using statik and echo with to serve up a single binary React app</h2>
<span class="date">2019-02-24</span>
<span class="updated">Updated 2020-10-11 · <a href="https://github.com/divanvisagie/blog/blob/aec63de882b0a4ef7cb31172cb6d66a7d06b49fc/content/post/single-binary-spa-go/index.md" target="_blank" rel="noopener">aec63de</a></span>
<p><img src="go-spa-head.png" alt="Header Image"></p>
<p>I think one of the most elegant things that Go does is output a single portable binary. So when building a full web application, it would be nice to keep the output just as simple.</p>
<p>Luckily, I wasn’t alone in this thought, and a neat little tool called <a href="https://github.com/rakyll/statik">statik</a> exists to do just that.</p>
<p>The library itself supplies sufficient documentation to get it working just for simply serving the application via Go’s http library, but, using it in a practical sense probably means that you want to use a framework like echo for things like endpoints and websockets. Here I will cover getting statik to serve files using the <a href="https://echo.labstack.com/">echo</a> framework.</p>
<h2>Creating the React App</h2>
<p>In this project I decided to follow some <a href="https://github.com/golang-standards/project-layout">golang-standards</a> and opt to put the react project in <code>./web</code>. This was fairly simple with <a href="https://github.com/facebook/create-react-app">create-react-app</a>:</p>
<pre><code class="language-sh">create-react-app web
</code></pre>
<p>We are going to need to install dependencies and build our react app for serving, so let’s run the following in the <code>./web</code> directory</p>
<pre><code class="language-sh">yarn
yarn build
</code></pre>
<p><code>create-react-app</code> creates this app as a git repository, so in order to not have issues with the parent repository, we should delete the .git inside the web folder.</p>
<pre><code class="language-sh">rm -rf .git
</code></pre>
<h2>Packaging the frontend</h2>
<p>Before we forget, let’s get back to the root directory of our project.</p>
<p>The next step would be to package the frontend into a go file, this part is done by the <code>statik</code> tool, so, time to go get that (pun intended):</p>
<pre><code class="language-sh">go get github.com/rakyll/statik
</code></pre>
<p>Now we could run the statik command to package the app, but there are some things that we are going to have to repeat every time some changes are made to the React app:</p>
<pre><code class="language-sh">cd web &amp;&amp; yarn &amp;&amp; yarn build &amp;&amp; cd ..
statik -src=./web/build
</code></pre>
<p>Repeating tasks should always be scripted, that’s your job as a software developer, so I think this is the perfect time to introduce a Makefile.</p>
<pre><code class="language-makefile">.ONESHELL:
.PHONY: statik

statik:
	cd web &amp;&amp; yarn build
	statik -src=./web/build

clean:
	rm -rf ./statik
</code></pre>
<p>Now running <code>make statik</code> will build our react app and then generate our statik Go file, this will become increasingly useful as we update our app.</p>
<h2>Serving the frontend</h2>
<p>Now that we have our packaged frontend, we need to serve it. Let’s create a main.go file:</p>
<pre><code class="language-go">package main

import (
	&quot;net/http&quot;

	_ &quot;github.com/divanvisagie/sbspa/statik&quot;
	&quot;github.com/labstack/echo&quot;
	&quot;github.com/rakyll/statik/fs&quot;
)

func main() {
	e := echo.New()
	addr := &quot;:8080&quot;

	statikFS, err := fs.New()
	if err != nil {
		e.Logger.Fatal(err)
	}

	h := http.FileServer(statikFS)

	e.GET(&quot;/*&quot;, echo.WrapHandler(http.StripPrefix(&quot;/&quot;, h)))

	e.Logger.Fatal(e.Start(addr))
}
</code></pre>
<p>There are some important things to note here.</p>
<p>In the imports you will see we are importing our packaged app with its fully qualified path:</p>
<pre><code class="language-go">_ &quot;github.com/divanvisagie/sbspa/statik&quot;
</code></pre>
<p>This is then used by <code>“github.com/rakyll/statik/fs”</code> for serving up the files simply by having the same package name.</p>
<p>The other is that for echo, we use the WrapHandler function since statik is designed for the built in HTTP library in Go and not special framework handlers. Luckily, echo is sane enough to provide us access to its underlying implementation.</p>
<pre><code class="language-go">e.GET(&quot;/*&quot;, echo.WrapHandler(http.StripPrefix(&quot;/&quot;, h)))
</code></pre>
<p>After this line you could can build up a normal echo server with routes and even websockets to back your app. Something I have done successfully but will not cover here since I think the <a href="https://echo.labstack.com/guide">documentation</a> of the library is quite sufficient.</p>
<p>Now, If we run</p>
<pre><code class="language-sh">go run main.go
</code></pre>
<p>We should get the following result on <a href="http://localhost:8080">http://localhost:8080</a> :</p>
<p><img src="go-spa-out.png" alt="Go SPA Output"></p>
<h2>Outputting the binary</h2>
<p>Finally we want to output our binary so that we can send our React virus to friends, enemies, docker containers, and whomever else finds opening random executables to be a good idea.</p>
<pre><code class="language-makefile">.ONESHELL:
.PHONY: statik all

all:
	$(MAKE) statik
	go build -o app ./main.go


statik:
	cd web &amp;&amp; yarn build
	statik -src=./web/build

clean:
	rm -rf ./statik
</code></pre>
<p>Now simply running <code>make</code> will give us the binary: <code>app</code>.
<img src="go-spa-echo.png" alt="Go-spa-Echo"></p>
<h2>Conclusion</h2>
<p>But Divan? This only allows me to run my React app on the OS I built it on, what if I want to run it on my x86 plan 9 machine?.
Fear not, this thing is written in Go, of course there is a tool for that. Enter <a href="https://github.com/mitchellh/gox">Gox</a>!
Okay, that was a bit of a joke… sort of. I never really got plan 9 builds working, but I did get it to build for all of these architectures, and Gox does support plan 9:</p>
<p><img src="go-spa-targets.png" alt="Go SPA Targets"></p>
<p>I do however think that tools like Gox and <a href="https://github.com/goreleaser/goreleaser">Goreleaser</a> demonstrate just why packaging an app like this is such a powerful concept. It opens up a lot of different strategies to deploy apps in the strangest ways on the strangest devices in a very simple format.</p>
</div>
</div>

    <footer>
      Divan Visagie • Copyright 2019-25 •
      <a href="mailto:me@divanv.com">me@divanv.com</a> •
      <span><a href="/cv">CV</a></span> •
      <span><a href="https://github.com/divanvisagie">GitHub</a></span> •
      <span><a href="/pman">pman</a></span> •
      <span><a href="/mdsql">mdsql</a></span> •
      <span><a href="/fretboard">Fretboard</a></span> •
      <span><a href="/weather">Weather</a></span>
    </footer>

    <script src="/js/mermaid.min.js"></script>
    <script src="/js/katex.min.js"></script>
    <script src="/js/katex-auto-render.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
          ]
        });
      });
    </script>
    <script src="/js/index.js"></script>
  </body>
</html>
